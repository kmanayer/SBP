(comment "CPSA 3.6.6")
(comment "Extracted shapes")

(herald "Session Binding Protocol (SBP)")

(comment "CPSA 3.6.6")

(comment "All input read from sbp_tls.lsp")

(defprotocol sbp basic
  (defrole client
    (vars (cc id s cred request answer data) (p name) (enc_cookie mesg))
    (trace (send cc) (recv id) (send (enc s (pubk p)))
      (send (enc id (hash s cc id))) (recv (enc cc (hash s cc id)))
      (send (enc "login-request" cred (hash s cc id)))
      (recv (enc "login-success" enc_cookie (hash s cc id)))
      (send (enc "request" request enc_cookie (hash s cc id)))
      (recv (enc "answer" answer (hash s cc id))))
    (uniq-gen cc s))
  (defrole proxy
    (vars (cc id s cred cookie request answer sskey data) (p name))
    (trace (recv cc) (send id) (recv (enc s (pubk p)))
      (send (enc id (hash s cc id))) (recv (enc cc (hash s cc id)))
      (recv (enc "login-request" cred (hash s cc id)))
      (send
        (enc "login-success" (enc cookie (hash sskey (hash s cc id)))
          (hash s cc id)))
      (recv
        (enc "request" request (enc cookie (hash sskey (hash s cc id)))
          (hash s cc id)))
      (send
        (enc "answer" answer (enc cookie (hash sskey (hash s cc id)))
          (hash s cc id))))
    (non-orig sskey (privk p))
    (uniq-orig answer)
    (uniq-gen id cookie)))

(defskeleton sbp
  (vars (enc_cookie mesg) (answer cc id s cred request data) (p name))
  (defstrand client 9 (enc_cookie enc_cookie) (cc cc) (id id) (s s)
    (cred cred) (request request) (answer answer) (p p))
  (non-orig (privk p))
  (uniq-gen cc s)
  (traces
    ((send cc) (recv id) (send (enc s (pubk p)))
      (send (enc id (hash s cc id))) (recv (enc cc (hash s cc id)))
      (send (enc "login-request" cred (hash s cc id)))
      (recv (enc "login-success" enc_cookie (hash s cc id)))
      (send (enc "request" request enc_cookie (hash s cc id)))
      (recv (enc "answer" answer (hash s cc id)))))
  (label 0)
  (unrealized (0 4) (0 6) (0 8))
  (origs)
  (comment "2 in cohort - 2 not yet seen"))

(comment "Nothing left to do")
