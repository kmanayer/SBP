(comment "CPSA 3.6.6")
(comment "Extracted shapes")

(herald "Session Binding Protocol (SBP)")

(comment "CPSA 3.6.6")

(comment "All input read from sbp_tls.lsp")

(defprotocol sbp basic
  (defrole client
    (vars (cred request answer data) (enc_cookie mesg) (p name))
    (trace (send (cat "login-request" cred))
      (recv (cat "login-success" enc_cookie))
      (send (cat "request" request enc_cookie))
      (recv (enc "answer" answer (privk p)))))
  (defrole proxy
    (vars (cc id s cred cookie request answer sskey data) (p name))
    (trace (recv cc) (send (cat id (pubk p))) (recv (enc s (pubk p)))
      (send (enc id (hash s cc id))) (recv (enc cc (hash s cc id)))
      (recv (enc "login-request" cred (hash s cc id)))
      (send
        (enc "login-success" (enc cookie (hash sskey (hash s cc id)))
          (hash s cc id)))
      (recv
        (enc "request" request (enc cookie (hash sskey (hash s cc id)))
          (hash s cc id)))
      (send (enc (enc "answer" answer (privk p)) (hash s cc id))))
    (uniq-gen answer)))

(defskeleton sbp
  (vars (enc_cookie mesg) (cred answer request data) (p name))
  (defstrand client 4 (enc_cookie enc_cookie) (cred cred)
    (request request) (answer answer) (p p))
  (non-orig (privk p))
  (traces
    ((send (cat "login-request" cred))
      (recv (cat "login-success" enc_cookie))
      (send (cat "request" request enc_cookie))
      (recv (enc "answer" answer (privk p)))))
  (label 0)
  (unrealized (0 3))
  (origs)
  (comment "1 in cohort - 1 not yet seen"))

(defskeleton sbp
  (vars (enc_cookie mesg)
    (cred answer request cc id s cred-0 cookie request-0 sskey data)
    (p name))
  (defstrand client 4 (enc_cookie enc_cookie) (cred cred)
    (request request) (answer answer) (p p))
  (defstrand proxy 9 (cc cc) (id id) (s s) (cred cred-0) (cookie cookie)
    (request request-0) (answer answer) (sskey sskey) (p p))
  (precedes ((1 8) (0 3)))
  (non-orig (privk p))
  (uniq-gen answer)
  (operation encryption-test (added-strand proxy 9)
    (enc "answer" answer (privk p)) (0 3))
  (traces
    ((send (cat "login-request" cred))
      (recv (cat "login-success" enc_cookie))
      (send (cat "request" request enc_cookie))
      (recv (enc "answer" answer (privk p))))
    ((recv cc) (send (cat id (pubk p))) (recv (enc s (pubk p)))
      (send (enc id (hash s cc id))) (recv (enc cc (hash s cc id)))
      (recv (enc "login-request" cred-0 (hash s cc id)))
      (send
        (enc "login-success" (enc cookie (hash sskey (hash s cc id)))
          (hash s cc id)))
      (recv
        (enc "request" request-0
          (enc cookie (hash sskey (hash s cc id))) (hash s cc id)))
      (send (enc (enc "answer" answer (privk p)) (hash s cc id)))))
  (label 1)
  (parent 0)
  (unrealized)
  (shape)
  (maps
    ((0)
      ((cred cred) (answer answer) (p p) (request request)
        (enc_cookie enc_cookie))))
  (origs))

(comment "Nothing left to do")
