(herald "Session Binding Protocol (SBP)")

(comment "CPSA 3.6.6")
(comment "All input read from sbp.lsp")

(defprotocol sbp basic
  (defrole client
    (vars (answer cookie tlskey sskey data))
    (trace (recv (enc "response" (enc cookie sskey) tlskey))
      (send (enc cookie sskey))
      (send (enc "request" (enc cookie sskey) tlskey))
      (recv (enc "sensitive" answer (enc cookie sskey) tlskey))))
  (defrole proxy
    (vars (answer cookie tlskey sskey data))
    (trace (send (enc "response" (enc cookie sskey) tlskey))
      (recv (enc "request" (enc cookie sskey) tlskey))
      (send (enc "sensitive" answer (enc cookie sskey) tlskey)))
    (non-orig sskey)
    (uniq-gen answer cookie)))

(defskeleton sbp
  (vars (answer tlskey cookie sskey cookie-0 sskey-0 data))
  (defstrand client 4 (answer answer) (cookie cookie) (tlskey tlskey)
    (sskey sskey))
  (defstrand proxy 3 (answer answer) (cookie cookie-0) (tlskey tlskey)
    (sskey sskey-0))
  (deflistener answer)
  (non-orig sskey-0)
  (pen-non-orig tlskey)
  (uniq-gen answer cookie-0)
  (traces
    ((recv (enc "response" (enc cookie sskey) tlskey))
      (send (enc cookie sskey))
      (send (enc "request" (enc cookie sskey) tlskey))
      (recv (enc "sensitive" answer (enc cookie sskey) tlskey)))
    ((send (enc "response" (enc cookie-0 sskey-0) tlskey))
      (recv (enc "request" (enc cookie-0 sskey-0) tlskey))
      (send (enc "sensitive" answer (enc cookie-0 sskey-0) tlskey)))
    ((recv answer) (send answer)))
  (label 0)
  (unrealized (0 0) (0 3) (1 1) (2 0))
  (preskeleton)
  (origs)
  (comment "Not a skeleton"))

(defskeleton sbp
  (vars (answer tlskey cookie sskey cookie-0 sskey-0 data))
  (defstrand client 4 (answer answer) (cookie cookie) (tlskey tlskey)
    (sskey sskey))
  (defstrand proxy 3 (answer answer) (cookie cookie-0) (tlskey tlskey)
    (sskey sskey-0))
  (deflistener answer)
  (precedes ((1 2) (0 3)) ((1 2) (2 0)))
  (non-orig sskey-0)
  (pen-non-orig tlskey)
  (uniq-gen answer cookie-0)
  (traces
    ((recv (enc "response" (enc cookie sskey) tlskey))
      (send (enc cookie sskey))
      (send (enc "request" (enc cookie sskey) tlskey))
      (recv (enc "sensitive" answer (enc cookie sskey) tlskey)))
    ((send (enc "response" (enc cookie-0 sskey-0) tlskey))
      (recv (enc "request" (enc cookie-0 sskey-0) tlskey))
      (send (enc "sensitive" answer (enc cookie-0 sskey-0) tlskey)))
    ((recv answer) (send answer)))
  (label 1)
  (parent 0)
  (unrealized (0 0) (0 3) (1 1) (2 0))
  (origs)
  (comment "1 in cohort - 1 not yet seen"))

(defskeleton sbp
  (vars (answer tlskey cookie sskey cookie-0 sskey-0 data))
  (defstrand client 4 (answer answer) (cookie cookie) (tlskey tlskey)
    (sskey sskey))
  (defstrand proxy 3 (answer answer) (cookie cookie-0) (tlskey tlskey)
    (sskey sskey-0))
  (deflistener answer)
  (deflistener tlskey)
  (precedes ((1 2) (0 3)) ((1 2) (2 0)) ((3 1) (2 0)))
  (non-orig sskey-0)
  (pen-non-orig tlskey)
  (uniq-gen answer cookie-0)
  (operation nonce-test (added-listener tlskey) answer (2 0)
    (enc "sensitive" answer (enc cookie-0 sskey-0) tlskey))
  (traces
    ((recv (enc "response" (enc cookie sskey) tlskey))
      (send (enc cookie sskey))
      (send (enc "request" (enc cookie sskey) tlskey))
      (recv (enc "sensitive" answer (enc cookie sskey) tlskey)))
    ((send (enc "response" (enc cookie-0 sskey-0) tlskey))
      (recv (enc "request" (enc cookie-0 sskey-0) tlskey))
      (send (enc "sensitive" answer (enc cookie-0 sskey-0) tlskey)))
    ((recv answer) (send answer)) ((recv tlskey) (send tlskey)))
  (label 2)
  (parent 1)
  (unrealized (0 0) (0 3) (1 1) (3 0))
  (comment "1 in cohort - 1 not yet seen"))

(defskeleton sbp
  (vars (answer cookie sskey cookie-0 sskey-0 data))
  (defstrand client 4 (answer answer) (cookie cookie) (tlskey cookie-0)
    (sskey sskey))
  (defstrand proxy 3 (answer answer) (cookie cookie-0) (tlskey cookie-0)
    (sskey sskey-0))
  (deflistener answer)
  (deflistener cookie-0)
  (precedes ((1 0) (0 0)) ((1 0) (3 0)) ((1 2) (0 3)) ((1 2) (2 0))
    ((3 1) (2 0)))
  (non-orig sskey-0)
  (pen-non-orig cookie-0)
  (uniq-gen answer cookie-0)
  (operation nonce-test (displaced 4 1 proxy 1) tlskey (3 0))
  (traces
    ((recv (enc "response" (enc cookie sskey) cookie-0))
      (send (enc cookie sskey))
      (send (enc "request" (enc cookie sskey) cookie-0))
      (recv (enc "sensitive" answer (enc cookie sskey) cookie-0)))
    ((send (enc "response" (enc cookie-0 sskey-0) cookie-0))
      (recv (enc "request" (enc cookie-0 sskey-0) cookie-0))
      (send (enc "sensitive" answer (enc cookie-0 sskey-0) cookie-0)))
    ((recv answer) (send answer)) ((recv cookie-0) (send cookie-0)))
  (label 3)
  (parent 2)
  (unrealized (0 0) (0 3) (1 1) (3 0))
  (comment "2 in cohort - 2 not yet seen"))

(defskeleton sbp
  (vars (answer cookie sskey data))
  (defstrand client 4 (answer answer) (cookie cookie) (tlskey cookie)
    (sskey sskey))
  (defstrand proxy 3 (answer answer) (cookie cookie) (tlskey cookie)
    (sskey sskey))
  (deflistener answer)
  (deflistener cookie)
  (precedes ((0 1) (3 0)) ((1 0) (0 0)) ((1 2) (0 3)) ((1 2) (2 0))
    ((3 1) (2 0)))
  (non-orig sskey)
  (pen-non-orig cookie)
  (uniq-gen answer cookie)
  (operation nonce-test (displaced 4 0 client 2) cookie-0 (3 0)
    (enc "response" (enc cookie-0 sskey-0) cookie-0))
  (traces
    ((recv (enc "response" (enc cookie sskey) cookie))
      (send (enc cookie sskey))
      (send (enc "request" (enc cookie sskey) cookie))
      (recv (enc "sensitive" answer (enc cookie sskey) cookie)))
    ((send (enc "response" (enc cookie sskey) cookie))
      (recv (enc "request" (enc cookie sskey) cookie))
      (send (enc "sensitive" answer (enc cookie sskey) cookie)))
    ((recv answer) (send answer)) ((recv cookie) (send cookie)))
  (label 4)
  (parent 3)
  (unrealized (1 1) (3 0))
  (dead)
  (comment "empty cohort"))

(defskeleton sbp
  (vars (answer cookie sskey cookie-0 sskey-0 data))
  (defstrand client 4 (answer answer) (cookie cookie) (tlskey cookie-0)
    (sskey sskey))
  (defstrand proxy 3 (answer answer) (cookie cookie-0) (tlskey cookie-0)
    (sskey sskey-0))
  (deflistener answer)
  (deflistener cookie-0)
  (defstrand client 2 (cookie cookie-0) (tlskey cookie-0)
    (sskey sskey-0))
  (precedes ((1 0) (0 0)) ((1 0) (4 0)) ((1 2) (0 3)) ((1 2) (2 0))
    ((3 1) (2 0)) ((4 1) (3 0)))
  (non-orig sskey-0)
  (pen-non-orig cookie-0)
  (uniq-gen answer cookie-0)
  (operation nonce-test (added-strand client 2) cookie-0 (3 0)
    (enc "response" (enc cookie-0 sskey-0) cookie-0))
  (traces
    ((recv (enc "response" (enc cookie sskey) cookie-0))
      (send (enc cookie sskey))
      (send (enc "request" (enc cookie sskey) cookie-0))
      (recv (enc "sensitive" answer (enc cookie sskey) cookie-0)))
    ((send (enc "response" (enc cookie-0 sskey-0) cookie-0))
      (recv (enc "request" (enc cookie-0 sskey-0) cookie-0))
      (send (enc "sensitive" answer (enc cookie-0 sskey-0) cookie-0)))
    ((recv answer) (send answer)) ((recv cookie-0) (send cookie-0))
    ((recv (enc "response" (enc cookie-0 sskey-0) cookie-0))
      (send (enc cookie-0 sskey-0))))
  (label 5)
  (parent 3)
  (unrealized (0 0) (0 3) (1 1) (3 0))
  (dead)
  (comment "empty cohort"))

(comment "Nothing left to do")
