(herald "Session Binding Protocol (SBP)")

(comment "CPSA 3.6.6")
(comment "All input read from sbp_tls.lsp")

(defprotocol sbp basic
  (defrole client
    (vars (cc id s cred request answer data) (p name) (enc_cookie mesg))
    (trace (send cc) (recv id) (send (enc s (pubk p)))
      (send (enc id (hash s cc id))) (recv (enc cc (hash s cc id)))
      (send (enc "login-request" cred (hash s cc id)))
      (recv (enc "login-success" enc_cookie (hash s cc id)))
      (send (enc "request" request enc_cookie (hash s cc id)))
      (recv (enc "answer" answer (hash s cc id))))
    (uniq-gen cc s))
  (defrole proxy
    (vars (cc id s cred cookie request answer sskey data) (p name))
    (trace (recv cc) (send id) (recv (enc s (pubk p)))
      (send (enc id (hash s cc id))) (recv (enc cc (hash s cc id)))
      (recv (enc "login-request" cred (hash s cc id)))
      (send
        (enc "login-success" (enc cookie (hash sskey (hash s cc id)))
          (hash s cc id)))
      (recv
        (enc "request" request (enc cookie (hash sskey (hash s cc id)))
          (hash s cc id)))
      (send
        (enc "answer" answer (enc cookie (hash sskey (hash s cc id)))
          (hash s cc id))))
    (non-orig sskey (privk p))
    (uniq-orig answer)
    (uniq-gen id cookie)))

(defskeleton sbp
  (vars (enc_cookie mesg) (answer cc id s cred request data) (p name))
  (defstrand client 9 (enc_cookie enc_cookie) (cc cc) (id id) (s s)
    (cred cred) (request request) (answer answer) (p p))
  (non-orig (privk p))
  (uniq-gen cc s)
  (traces
    ((send cc) (recv id) (send (enc s (pubk p)))
      (send (enc id (hash s cc id))) (recv (enc cc (hash s cc id)))
      (send (enc "login-request" cred (hash s cc id)))
      (recv (enc "login-success" enc_cookie (hash s cc id)))
      (send (enc "request" request enc_cookie (hash s cc id)))
      (recv (enc "answer" answer (hash s cc id)))))
  (label 0)
  (unrealized (0 4) (0 6) (0 8))
  (origs)
  (comment "2 in cohort - 2 not yet seen"))

(defskeleton sbp
  (vars (enc_cookie mesg) (answer id s cred request data) (p name))
  (defstrand client 9 (enc_cookie enc_cookie) (cc id) (id id) (s s)
    (cred cred) (request request) (answer answer) (p p))
  (non-orig (privk p))
  (uniq-gen id s)
  (operation encryption-test (displaced 1 0 client 4)
    (enc id (hash s id id)) (0 4))
  (traces
    ((send id) (recv id) (send (enc s (pubk p)))
      (send (enc id (hash s id id))) (recv (enc id (hash s id id)))
      (send (enc "login-request" cred (hash s id id)))
      (recv (enc "login-success" enc_cookie (hash s id id)))
      (send (enc "request" request enc_cookie (hash s id id)))
      (recv (enc "answer" answer (hash s id id)))))
  (label 1)
  (parent 0)
  (unrealized (0 6) (0 8))
  (origs)
  (comment "1 in cohort - 1 not yet seen"))

(defskeleton sbp
  (vars (enc_cookie mesg) (answer cc id s cred request data) (p name))
  (defstrand client 9 (enc_cookie enc_cookie) (cc cc) (id id) (s s)
    (cred cred) (request request) (answer answer) (p p))
  (deflistener (hash s cc id))
  (precedes ((0 2) (1 0)) ((1 1) (0 4)))
  (non-orig (privk p))
  (uniq-gen cc s)
  (operation encryption-test (added-listener (hash s cc id))
    (enc cc (hash s cc id)) (0 4))
  (traces
    ((send cc) (recv id) (send (enc s (pubk p)))
      (send (enc id (hash s cc id))) (recv (enc cc (hash s cc id)))
      (send (enc "login-request" cred (hash s cc id)))
      (recv (enc "login-success" enc_cookie (hash s cc id)))
      (send (enc "request" request enc_cookie (hash s cc id)))
      (recv (enc "answer" answer (hash s cc id))))
    ((recv (hash s cc id)) (send (hash s cc id))))
  (label 2)
  (parent 0)
  (unrealized (1 0))
  (comment "1 in cohort - 1 not yet seen"))

(defskeleton sbp
  (vars (enc_cookie mesg) (answer id s cred request data) (p name))
  (defstrand client 9 (enc_cookie enc_cookie) (cc id) (id id) (s s)
    (cred cred) (request request) (answer answer) (p p))
  (deflistener (hash s id id))
  (precedes ((0 2) (1 0)) ((1 1) (0 6)))
  (non-orig (privk p))
  (uniq-gen id s)
  (operation encryption-test (added-listener (hash s id id))
    (enc "login-success" enc_cookie (hash s id id)) (0 6))
  (traces
    ((send id) (recv id) (send (enc s (pubk p)))
      (send (enc id (hash s id id))) (recv (enc id (hash s id id)))
      (send (enc "login-request" cred (hash s id id)))
      (recv (enc "login-success" enc_cookie (hash s id id)))
      (send (enc "request" request enc_cookie (hash s id id)))
      (recv (enc "answer" answer (hash s id id))))
    ((recv (hash s id id)) (send (hash s id id))))
  (label 3)
  (parent 1)
  (unrealized (1 0))
  (comment "1 in cohort - 1 not yet seen"))

(defskeleton sbp
  (vars (enc_cookie mesg) (answer cc id s cred request data) (p name))
  (defstrand client 9 (enc_cookie enc_cookie) (cc cc) (id id) (s s)
    (cred cred) (request request) (answer answer) (p p))
  (deflistener (hash s cc id))
  (deflistener (cat s cc id))
  (precedes ((0 2) (2 0)) ((1 1) (0 4)) ((2 1) (1 0)))
  (non-orig (privk p))
  (uniq-gen cc s)
  (operation encryption-test (added-listener (cat s cc id))
    (hash s cc id) (1 0))
  (traces
    ((send cc) (recv id) (send (enc s (pubk p)))
      (send (enc id (hash s cc id))) (recv (enc cc (hash s cc id)))
      (send (enc "login-request" cred (hash s cc id)))
      (recv (enc "login-success" enc_cookie (hash s cc id)))
      (send (enc "request" request enc_cookie (hash s cc id)))
      (recv (enc "answer" answer (hash s cc id))))
    ((recv (hash s cc id)) (send (hash s cc id)))
    ((recv (cat s cc id)) (send (cat s cc id))))
  (label 4)
  (parent 2)
  (unrealized (2 0))
  (dead)
  (comment "empty cohort"))

(defskeleton sbp
  (vars (enc_cookie mesg) (answer id s cred request data) (p name))
  (defstrand client 9 (enc_cookie enc_cookie) (cc id) (id id) (s s)
    (cred cred) (request request) (answer answer) (p p))
  (deflistener (hash s id id))
  (deflistener (cat s id id))
  (precedes ((0 2) (2 0)) ((1 1) (0 6)) ((2 1) (1 0)))
  (non-orig (privk p))
  (uniq-gen id s)
  (operation encryption-test (added-listener (cat s id id))
    (hash s id id) (1 0))
  (traces
    ((send id) (recv id) (send (enc s (pubk p)))
      (send (enc id (hash s id id))) (recv (enc id (hash s id id)))
      (send (enc "login-request" cred (hash s id id)))
      (recv (enc "login-success" enc_cookie (hash s id id)))
      (send (enc "request" request enc_cookie (hash s id id)))
      (recv (enc "answer" answer (hash s id id))))
    ((recv (hash s id id)) (send (hash s id id)))
    ((recv (cat s id id)) (send (cat s id id))))
  (label 5)
  (parent 3)
  (unrealized (2 0))
  (comment "1 in cohort - 1 not yet seen"))

(defskeleton sbp
  (vars (enc_cookie mesg) (answer id cred request data) (p name))
  (defstrand client 9 (enc_cookie enc_cookie) (cc id) (id id) (s cred)
    (cred cred) (request request) (answer answer) (p p))
  (deflistener (hash cred id id))
  (deflistener (cat cred id id))
  (precedes ((0 5) (2 0)) ((1 1) (0 6)) ((2 1) (1 0)))
  (non-orig (privk p))
  (uniq-gen id cred)
  (operation nonce-test (displaced 3 0 client 6) s (2 0)
    (enc s (pubk p)))
  (traces
    ((send id) (recv id) (send (enc cred (pubk p)))
      (send (enc id (hash cred id id)))
      (recv (enc id (hash cred id id)))
      (send (enc "login-request" cred (hash cred id id)))
      (recv (enc "login-success" enc_cookie (hash cred id id)))
      (send (enc "request" request enc_cookie (hash cred id id)))
      (recv (enc "answer" answer (hash cred id id))))
    ((recv (hash cred id id)) (send (hash cred id id)))
    ((recv (cat cred id id)) (send (cat cred id id))))
  (label 6)
  (parent 5)
  (unrealized (2 0))
  (comment "1 in cohort - 1 not yet seen"))

(defskeleton sbp
  (vars (enc_cookie mesg) (answer id cred request data) (p name))
  (defstrand client 9 (enc_cookie enc_cookie) (cc id) (id id) (s cred)
    (cred cred) (request request) (answer answer) (p p))
  (deflistener (hash cred id id))
  (deflistener (cat cred id id))
  (deflistener (hash cred id id))
  (precedes ((0 2) (3 0)) ((0 5) (2 0)) ((1 1) (0 6)) ((2 1) (1 0))
    ((3 1) (2 0)))
  (non-orig (privk p))
  (uniq-gen id cred)
  (operation nonce-test (added-listener (hash cred id id)) cred (2 0)
    (enc cred (pubk p)) (enc "login-request" cred (hash cred id id)))
  (traces
    ((send id) (recv id) (send (enc cred (pubk p)))
      (send (enc id (hash cred id id)))
      (recv (enc id (hash cred id id)))
      (send (enc "login-request" cred (hash cred id id)))
      (recv (enc "login-success" enc_cookie (hash cred id id)))
      (send (enc "request" request enc_cookie (hash cred id id)))
      (recv (enc "answer" answer (hash cred id id))))
    ((recv (hash cred id id)) (send (hash cred id id)))
    ((recv (cat cred id id)) (send (cat cred id id)))
    ((recv (hash cred id id)) (send (hash cred id id))))
  (label 7)
  (parent 6)
  (unrealized (3 0))
  (comment "1 in cohort - 1 not yet seen"))

(defskeleton sbp
  (vars (enc_cookie mesg) (answer id cred request data) (p name))
  (defstrand client 9 (enc_cookie enc_cookie) (cc id) (id id) (s cred)
    (cred cred) (request request) (answer answer) (p p))
  (deflistener (hash cred id id))
  (deflistener (cat cred id id))
  (deflistener (hash cred id id))
  (deflistener (cat cred id id))
  (precedes ((0 2) (4 0)) ((0 5) (2 0)) ((1 1) (0 6)) ((2 1) (1 0))
    ((3 1) (2 0)) ((4 1) (3 0)))
  (non-orig (privk p))
  (uniq-gen id cred)
  (operation encryption-test (added-listener (cat cred id id))
    (hash cred id id) (3 0))
  (traces
    ((send id) (recv id) (send (enc cred (pubk p)))
      (send (enc id (hash cred id id)))
      (recv (enc id (hash cred id id)))
      (send (enc "login-request" cred (hash cred id id)))
      (recv (enc "login-success" enc_cookie (hash cred id id)))
      (send (enc "request" request enc_cookie (hash cred id id)))
      (recv (enc "answer" answer (hash cred id id))))
    ((recv (hash cred id id)) (send (hash cred id id)))
    ((recv (cat cred id id)) (send (cat cred id id)))
    ((recv (hash cred id id)) (send (hash cred id id)))
    ((recv (cat cred id id)) (send (cat cred id id))))
  (label 8)
  (parent 7)
  (seen 6)
  (unrealized (4 0))
  (comment "1 in cohort - 0 not yet seen"))

(comment "Nothing left to do")
